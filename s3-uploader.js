// Generated by CoffeeScript 1.8.0
(function() {
  angular.module('s3-uploader', []).provider("S3Uploader", function() {
    var provider;
    provider = {
      $get: [
        '$q', 'randomString', function($q, randomString) {
          return {
            upload: function(file) {
              var bucket, deferred, filename, params;
              AWS.config.update({
                accessKeyId: provider.credentials.access_key,
                secretAccessKey: provider.credentials.secret_key
              });
              AWS.config.region = provider.credentials.region;
              bucket = new AWS.S3({
                params: {
                  Bucket: provider.credentials.bucket
                },
                signatureVersion: 'v4'
              });
              filename = randomString(15) + '_' + file.name;
              params = {
                Key: filename,
                ContentType: file.type,
                Body: file,
                ACL: 'public-read'
              };
              deferred = $q.defer();
              bucket.putObject(params, function(err, data) {
                var file_url, request;
                if (err) {
                  return deferred.reject(err);
                } else {
                  request = this.request.httpRequest;
                  file_url = request.endpoint.protocol + '//' + request.endpoint.host + request.path;
                  return deferred.resolve(file_url);
                }
              }).on('httpUploadProgress', function(progress) {
                return deferred.notify(Math.round(progress.loaded / progress.total * 100));
              });
              return deferred.promise;
            }
          };
        }
      ],
      credentials: {
        access_key: '',
        secret_key: '',
        bucket: '',
        region: ''
      }
    };
    return provider;
  }).directive('remoteUpload', [
    'S3Uploader', '$parse', '$compile', function(S3Uploader, $parse, $compile) {
      return {
        require: 'ngModel',
        restrict: 'A',
        scope: {
          model: '=ngModel',
          afterUpload: '&afterFileUpload'
        },
        link: function(scope, elem, attrs) {
          var fieldName, getProgress, isDrop, isMultiple, setProgress, _ref;
          scope.file = null;
          isDrop = angular.isDefined(attrs.dragdrop);
          isMultiple = angular.isDefined(attrs.multiple);
          if (isDrop) {
            elem.attr('ng-file-drop', '');
            elem.attr('allowDir', 'false');
          } else {
            elem.attr('ng-file-select', '');
          }
          elem.removeAttr('remote-upload');
          elem.removeAttr('multiple');
          elem.attr('ng-model', 'file');
          if (!elem.attr('accept')) {
            elem.attr('accept', '.p12,image/*');
          }
          elem.attr('ng-multiple', (_ref = isMultiple) != null ? _ref : {
            'true': 'false'
          });
          $compile(elem)(scope);
          fieldName = $parse(attrs.name);
          setProgress = function(progress_obj) {
            return fieldName.assign(scope.$parent, progress_obj);
          };
          getProgress = function() {
            return fieldName(scope.$parent);
          };
          return scope.$watch('file', function(values) {
            if (values) {
              if (isMultiple) {
                if (!angular.isArray(scope.model)) {
                  scope.model = [];
                }
                angular.forEach(values, function(value) {
                  scope.model.push({
                    file: value,
                    file_name: value.name,
                    upload_progress: 0,
                    file_uploading: true
                  });
                  return value.fileQueue = scope.model.length;
                });
                return angular.forEach(values, function(value) {
                  var fileIndex;
                  fileIndex = value.fileQueue - 1;
                  return S3Uploader.upload(value).then(function(filename) {
                    scope.model[fileIndex].remote_file_url = filename;
                    if (scope.afterUpload) {
                      return scope.afterUpload({
                        file: scope.model[fileIndex]
                      });
                    }
                  }, function(rejection) {
                    scope.model[fileIndex].error = rejection;
                    return scope.model[fileIndex].upload_progress = 0;
                  }, function(progress) {
                    return scope.model[fileIndex].upload_progress = progress;
                  });
                });
              } else {
                setProgress({
                  progress: 0
                });
                return S3Uploader.upload(values[0]).then(function(filename) {
                  scope.model = filename;
                  if (scope.afterUpload) {
                    return scope.afterUpload({
                      file: scope.model
                    });
                  }
                }, function(rejection) {
                  return setProgress({
                    error: rejection,
                    progress: 0
                  });
                }, function(progress) {
                  return setProgress({
                    progress: progress
                  });
                });
              }
            }
          });
        }
      };
    }
  ]);

}).call(this);
